<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng x·∫øp h·∫°ng - Qu·∫•tWin</title>
    <link rel="stylesheet" href="../css/index.css">
    <style>
        :root {
            --primary: #4ecdc4;
            --secondary: #44a08d;
            --accent: #ff6b6b;
            --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-strong: #ffffff;
            --text-soft: #e0e0e0;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text-strong);
        }

        .leaderboard-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            padding-top: 100px;
            width: 70%
        }

        .leaderboard-content {
            display: flex;
            gap: 30px;
            width: 100%;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .leaderboard-title {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .leaderboard-subtitle {
            font-size: 1.3rem;
            color: var(--text-soft);
            margin-bottom: 30px;
        }

        .leaderboard-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 300px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--text-soft);
            font-weight: 600;
        }

        .leaderboard-table {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            overflow: hidden;
            box-shadow: var(--shadow);
            flex: 1;
            width: 100%;
            min-width: 0;
        }

        .table-header {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            padding: 25px;
            text-align: center;
        }

        .table-title {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 0;
            color: white;
        }

        .table-content {
            padding: 0;
        }



        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-soft);
        }

        .error {
            text-align: center;
            padding: 40px;
            color: var(--accent);
            font-size: 1.1rem;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-soft);
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .leaderboard-content {
                flex-direction: column;
            }

            .leaderboard-stats {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>
    <img id="menuTriggerLogo" src="../stream/logo.png" alt="logo" />
    <nav class="sidebar-nav hidden">
        <div class="logo">
            <h1>Qu·∫•tWin</h1>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="../index.html" class="nav-link" id="gameLink">
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor"
                            d="M8 0C3.58 0 0 3.58 0 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z" />
                        <circle cx="5" cy="8" r="1" />
                        <circle cx="8" cy="8" r="1" />
                        <circle cx="11" cy="8" r="1" />
                    </svg>
                    <span>Tr√≤ ch∆°i</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="stats.html" class="nav-link">
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor"
                            d="M0 0h16v16H0V0zm1 1v14h14V1H1zm2 2h10v1H3V3zm0 2h10v1H3V5zm0 2h7v1H3V7zm0 2h5v1H3V9z" />
                    </svg>
                    <span>Th·ªëng k√™</span>
                </a>
            </li>
            <li class="nav-item active">
                <a href="leaderboard.html" class="nav-link">
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor"
                            d="M8 0C3.58 0 0 3.58 0 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z" />
                        <path fill="currentColor"
                            d="M8 2C4.69 2 2 4.69 2 8s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" />
                        <path fill="currentColor"
                            d="M8 4c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                    </svg>
                    <span>B·∫£ng x·∫øp h·∫°ng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="help.html" class="nav-link">
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor"
                            d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path fill="currentColor"
                            d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-1.01 1.16-.408.133-.958.304-1.01.832-.01.178.03.347.102.446a.25.25 0 0 0 .192.14h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.16-.408.133-.958.304-1.01.832-.01.178-.03-.347-.102-.446a.25.25 0 0 0 .192.14H6.5a.25.25 0 0 0-.25.25v.105z" />
                    </svg>
                    <span>Tr·ª£ gi√∫p</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="logoutLink">
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor"
                            d="M6 12c0 .55.45 1 1 1s1-.45 1-1V7h2c.55 0 1-.45 1-1s-.45-1-1-1H8V2c0-.55-.45-1-1-1s-1 .45-1 1v3H4c-.55 0-1 .45-1 1s.45 1 1 1h2v5z" />
                    </svg>
                    <span>ƒêƒÉng xu·∫•t</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h1 class="leaderboard-title">üèÜ B·∫£ng x·∫øp h·∫°ng</h1>
            <p class="leaderboard-subtitle">Top nh·ªØng ng∆∞·ªùi ch∆°i xu·∫•t s·∫Øc nh·∫•t</p>
        </div>

        <div class="leaderboard-content">
            <div class="leaderboard-stats" id="leaderboardStats">
                <div class="stat-card">
                    <div class="stat-number" id="totalPlayers">-</div>
                    <div class="stat-label">T·ªïng ng∆∞·ªùi ch∆°i</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalGames">-</div>
                    <div class="stat-label">T·ªïng v√°n ch∆°i</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalWins">-</div>
                    <div class="stat-label">T·ªïng l·∫ßn th·∫Øng</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBalance">-</div>
                    <div class="stat-label">T·ªïng s·ªë d∆∞</div>
                </div>
            </div>

            <div class="leaderboard-table">
                <div class="table-header">
                    <h2 class="table-title">üìä Top ng∆∞·ªùi ch∆°i</h2>
                </div>
                <div class="table-content">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(255, 255, 255, 0.1);">
                                <th
                                    style="padding: 20px; text-align: center; font-weight: 900; color: var(--text-strong); font-size: 1.6rem;">
                                    H·∫°ng</th>
                                <th
                                    style="padding: 20px; text-align: left; font-weight: 900; color: var(--text-strong); font-size: 1.6rem;">
                                    Ng∆∞·ªùi ch∆°i</th>
                                <th
                                    style="padding: 20px; text-align: center; font-weight: 900; color: var(--text-strong); font-size: 1.6rem;">
                                    S·ªë d∆∞</th>
                                <th
                                    style="padding: 20px; text-align: center; font-weight: 900; color: var(--text-strong); font-size: 1.6rem;">
                                    Th·∫Øng/V√°n ch∆°i</th>
                                <th
                                    style="padding: 20px; text-align: center; font-weight: 900; color: var(--text-strong); font-size: 1.6rem;">
                                    T·ªâ l·ªá th·∫Øng</th>
                                <th
                                    style="padding: 20px; text-align: center; font-weight: 900; color: var(--text-strong); font-size: 1.6rem;">
                                    L·ª£i nhu·∫≠n</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardList">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-soft); font-size: 1.6rem; font-weight: 700;">ƒêang
                                    t·∫£i d·ªØ li·ªáu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout popup -->
    <div id="logoutPopup" class="logout-popup" style="display: none;">
        <div class="logout-content">
            <h3 class="logout-title">ƒêƒÉng xu·∫•t</h3>
            <p class="logout-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?</p>
            <div class="logout-buttons">
                <button class="logout-cancel" onclick="closeLogoutPopup()">H·ªßy</button>
                <button class="logout-confirm" onclick="confirmLogout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const token = localStorage.getItem('quatwin_token');

        // Check authentication
        console.log('üîç Debug - Token:', token);
        console.log('üîç Debug - Token length:', token ? token.length : 0);
        console.log('üîç Debug - Current URL:', window.location.href);
        console.log('üîç Debug - localStorage keys:', Object.keys(localStorage));

        if (!token || token === 'null' || token === 'undefined') {
            console.log('‚ùå No valid token found, redirecting to login');
            window.location.href = '../login.html';
        } else {
            console.log('‚úÖ Valid token found, staying on leaderboard');
        }

        // Load leaderboard data
        async function loadLeaderboard() {
            console.log('üöÄ Starting to load leaderboard...');
            try {
                console.log('üì° Fetching from:', `${API_BASE}/leaderboard`);
                const response = await fetch(`${API_BASE}/leaderboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`Failed to load leaderboard: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìä Leaderboard data:', data);
                displayLeaderboard(data);
            } catch (error) {
                console.error('‚ùå Error loading leaderboard:', error);
                document.getElementById('leaderboardList').innerHTML = '<div class="error">L·ªói t·∫£i d·ªØ li·ªáu</div>';
            }
        }

        // Display leaderboard data
        function displayLeaderboard(data) {
            console.log('üìä Displaying leaderboard data:', data);

            // Update stats
            document.getElementById('totalPlayers').textContent = data.totalPlayers || 0;
            document.getElementById('totalGames').textContent = data.totalGames || 0;
            document.getElementById('totalWins').textContent = data.totalWins || 0;
            document.getElementById('totalBalance').textContent = (data.totalBalance || 0).toLocaleString() + ' ‚Ç´';

            // Display players - Table format like history
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';

            if (data.players && data.players.length > 0) {
                data.players.forEach((player, index) => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
                    row.style.transition = 'background-color 0.3s ease';

                    // Hover effect
                    row.addEventListener('mouseenter', () => {
                        row.style.backgroundColor = 'rgba(78, 205, 196, 0.1)';
                    });
                    row.addEventListener('mouseleave', () => {
                        row.style.backgroundColor = 'transparent';
                    });

                    const rankText = index + 1;
                    const balanceText = player.balance.toLocaleString('vi-VN') + ' ‚Ç´';
                    
                    // T√≠nh l·ª£i nhu·∫≠n v√† m√†u s·∫Øc
                    const profit = player.totalProfit || 0;
                    let profitColor = '#66bb6a'; // Xanh l√° (l√£i)
                    if (profit < 0) {
                        profitColor = '#ff6b6b'; // ƒê·ªè (l·ªó)
                    } else if (profit === 0) {
                        profitColor = '#ffd700'; // V√†ng (h√≤a)
                    }
                    const profitText = profit.toLocaleString('vi-VN') + ' ‚Ç´';
                    
                    // T√≠nh t·ªâ l·ªá th·∫Øng v√† m√†u s·∫Øc
                    const winRate = player.totalGames > 0 ? ((player.totalWins / player.totalGames) * 100).toFixed(1) : '0.0';
                    let winRateColor = '#ff6b6b'; // ƒê·ªè (th·∫•p)
                    if (parseFloat(winRate) >= 60) {
                        winRateColor = '#66bb6a'; // Xanh l√° (cao)
                    } else if (parseFloat(winRate) >= 40) {
                        winRateColor = '#ffd700'; // V√†ng (trung b√¨nh)
                    }
                    
                    row.innerHTML = `
                        <td style="padding: 20px; text-align: center; font-size: 2.2rem; font-weight: 900; color: #ffd700;">${rankText}</td>
                        <td style="padding: 20px; text-align: left;">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div style="width: 55px; height: 55px; border-radius: 50%; background: linear-gradient(135deg, #4ecdc4, #44a08d); display: flex; align-items: center; justify-content: center; font-weight: 900; color: white; font-size: 1.8rem;">${player.username.charAt(0).toUpperCase()}</div>
                                <div style="font-size: 1.6rem; font-weight: 900; color: var(--text-strong);">${player.username}</div>
                            </div>
                        </td>
                        <td style="padding: 20px; text-align: center; color: #4ecdc4; font-weight: 900; font-size: 1.6rem;">${balanceText}</td>
                        <td style="padding: 20px; text-align: center; color: #ff6b6b; font-weight: 900; font-size: 1.6rem;">${player.totalWins}/${player.totalGames}</td>
                        <td style="padding: 20px; text-align: center; color: ${winRateColor}; font-weight: 900; font-size: 1.6rem;">${winRate}%</td>
                        <td style="padding: 20px; text-align: center; color: ${profitColor}; font-weight: 900; font-size: 1.6rem;">${profitText}</td>
                    `;

                    leaderboardList.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center; padding: 40px; color: var(--text-soft); font-size: 1.6rem; font-weight: 700;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>';
                leaderboardList.appendChild(row);
            }
        }

        // Logout functions
        function showLogoutPopup() {
            document.getElementById('logoutPopup').style.display = 'flex';
        }

        function closeLogoutPopup() {
            document.getElementById('logoutPopup').style.display = 'none';
        }

        function confirmLogout() {
            localStorage.removeItem('token');
            window.location.href = '../login.html';
        }

        // Sidebar toggle
        document.getElementById('menuTriggerLogo').addEventListener('click', function () {
            const sidebar = document.querySelector('.sidebar-nav');
            sidebar.classList.toggle('hidden');
        });

        // Logout link
        document.getElementById('logoutLink').addEventListener('click', function (e) {
            e.preventDefault();
            showLogoutPopup();
        });

        // Load leaderboard on page load
        loadLeaderboard();
    </script>
</body>

</html>